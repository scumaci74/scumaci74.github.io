<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2563eb">
  <title>Offline Reader Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .animate-slide-in { animation: slideIn 0.3s ease-out; }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-purple-50">
  <div id="app"></div>

  <script>
    // CORS Proxy
    const CORS_PROXY = 'https://api.allorigins.win/raw?url=';

    // State
    let state = {
      articles: [],
      selectedArticle: null,
      view: 'list',
      showSettings: false,
      showAddUrl: false,
      loading: false,
      notification: null,
      searchQuery: '',
      apiKey: localStorage.getItem('apiKey') || '',
      provider: localStorage.getItem('provider') || 'gemini',
      urlInput: ''
    };

    // IndexedDB
    const DB_NAME = 'OfflineReaderDB';
    const STORE_NAME = 'articles';

    const openDB = () => {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, 1);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        request.onupgradeneeded = (e) => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
          }
        };
      });
    };

    const saveArticleToDB = async (article) => {
      const db = await openDB();
      return new Promise((resolve) => {
        const tx = db.transaction([STORE_NAME], 'readwrite');
        tx.objectStore(STORE_NAME).put(article);
        tx.oncomplete = () => resolve();
      });
    };

    const getAllArticles = async () => {
      const db = await openDB();
      return new Promise((resolve) => {
        const tx = db.transaction([STORE_NAME], 'readonly');
        const req = tx.objectStore(STORE_NAME).getAll();
        req.onsuccess = () => resolve(req.result);
      });
    };

    const deleteArticleFromDB = async (id) => {
      const db = await openDB();
      return new Promise((resolve) => {
        const tx = db.transaction([STORE_NAME], 'readwrite');
        tx.objectStore(STORE_NAME).delete(id);
        tx.oncomplete = () => resolve();
      });
    };

    // Utilities
    const showNotification = (message, type = 'success') => {
      state.notification = { message, type };
      render();
      setTimeout(() => {
        state.notification = null;
        render();
      }, 3000);
    };

    const fetchArticleContent = async (url) => {
      try {
        const proxyUrl = CORS_PROXY + encodeURIComponent(url);
        const response = await fetch(proxyUrl);
        
        if (!response.ok) throw new Error('Impossibile scaricare la pagina');
        
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        ['script', 'style', 'nav', 'footer', 'header', 'iframe', 'aside', 'noscript'].forEach(tag => {
          doc.querySelectorAll(tag).forEach(el => el.remove());
        });
        
        const title = doc.querySelector('title')?.textContent || 
                     doc.querySelector('h1')?.textContent || 
                     'Articolo';
        
        const article = doc.querySelector('article') || 
                       doc.querySelector('main') || 
                       doc.querySelector('.content') ||
                       doc.body;
        
        const content = article.innerText.trim().replace(/\s+/g, ' ').substring(0, 50000);
        
        if (!content || content.length < 100) {
          throw new Error('Contenuto troppo breve');
        }
        
        return {
          id: Date.now(),
          url,
          title: title.substring(0, 200).trim(),
          content,
          savedAt: new Date().toISOString(),
          summary: null,
          translation: null
        };
      } catch (error) {
        throw new Error('Impossibile scaricare l\'articolo');
      }
    };

    const callAI = async (prompt) => {
      const { apiKey, provider } = state;
      
      if (provider === 'gemini') {
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          console.error('Errore Gemini:', data);
          if (data.error) {
            throw new Error(`Gemini: ${data.error.message || data.error.status}`);
          }
          throw new Error('Errore API Gemini. Verifica la chiave API nelle impostazioni.');
        }
        
        if (!data.candidates || !data.candidates[0]) {
          console.error('Risposta Gemini:', data);
          throw new Error('Risposta non valida da Gemini');
        }
        
        return data.candidates[0].content.parts[0].text;
      } else if (provider === 'openai') {
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json', 
            'Authorization': `Bearer ${apiKey}` 
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [{ role: 'user', content: prompt }],
            max_tokens: 1000
          })
        });
        
        const data = await res.json();
        
        if (!res.ok) {
          console.error('Errore OpenAI:', data);
          throw new Error(`OpenAI: ${data.error?.message || 'Errore API'}`);
        }
        
        return data.choices[0].message.content;
      }
    };

    // Actions
    window.addArticle = async () => {
      if (!state.urlInput.trim()) {
        showNotification('Inserisci un URL valido', 'error');
        return;
      }

      try {
        new URL(state.urlInput);
      } catch (e) {
        showNotification('URL non valido', 'error');
        return;
      }

      state.loading = true;
      render();

      try {
        const article = await fetchArticleContent(state.urlInput);
        await saveArticleToDB(article);
        state.articles.unshift(article);
        state.urlInput = '';
        state.showAddUrl = false;
        showNotification('‚úÖ Articolo salvato!');
      } catch (error) {
        showNotification('‚ùå ' + error.message, 'error');
      } finally {
        state.loading = false;
        render();
      }
    };

    window.summarizeArticle = async (articleId) => {
      if (!state.apiKey) {
        showNotification('‚ö†Ô∏è Configura API', 'error');
        return;
      }

      const article = state.articles.find(a => a.id === articleId);
      state.loading = true;
      render();

      try {
        const prompt = `Riassunto dettagliato in italiano:\n\n${article.content.substring(0, 12000)}`;
        const summary = await callAI(prompt);
        
        article.summary = summary;
        await saveArticleToDB(article);
        
        if (state.selectedArticle?.id === articleId) state.selectedArticle = article;
        showNotification('‚ú® Riassunto generato!');
      } catch (error) {
        showNotification('‚ùå ' + error.message, 'error');
      } finally {
        state.loading = false;
        render();
      }
    };

    window.translateArticle = async (articleId) => {
      if (!state.apiKey) {
        showNotification('‚ö†Ô∏è Configura API', 'error');
        return;
      }

      const article = state.articles.find(a => a.id === articleId);
      state.loading = true;
      render();

      try {
        const prompt = `Traduci in italiano:\n\n${article.content.substring(0, 12000)}`;
        const translation = await callAI(prompt);
        
        article.translation = translation;
        await saveArticleToDB(article);
        
        if (state.selectedArticle?.id === articleId) state.selectedArticle = article;
        showNotification('üåç Tradotto!');
      } catch (error) {
        showNotification('‚ùå ' + error.message, 'error');
      } finally {
        state.loading = false;
        render();
      }
    };

    window.exportArticle = (articleId) => {
      const article = state.articles.find(a => a.id === articleId);
      const content = `${article.title}\n\nURL: ${article.url}\n\n${article.summary ? 'RIASSUNTO:\n' + article.summary + '\n\n' : ''}${article.translation ? 'TRADUZIONE:\n' + article.translation + '\n\n' : ''}CONTENUTO:\n${article.content}`;
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${article.title.substring(0, 50).replace(/[^a-z0-9]/gi, '_')}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showNotification('üìÑ Esportato!');
    };

    window.deleteArticle = async (id) => {
      if (!confirm('Eliminare?')) return;
      
      await deleteArticleFromDB(id);
      state.articles = state.articles.filter(a => a.id !== id);
      
      if (state.selectedArticle?.id === id) {
        state.selectedArticle = null;
        state.view = 'list';
      }
      
      showNotification('üóëÔ∏è Eliminato');
      render();
    };

    window.selectArticle = (articleId) => {
      state.selectedArticle = state.articles.find(a => a.id === articleId);
      state.view = 'reader';
      render();
    };

    window.backToList = () => {
      state.view = 'list';
      state.selectedArticle = null;
      render();
    };

    window.saveSettings = () => {
      localStorage.setItem('apiKey', state.apiKey);
      localStorage.setItem('provider', state.provider);
      state.showSettings = false;
      showNotification('‚úÖ Salvato!');
      render();
    };

    // Render
    const render = () => {
      const filteredArticles = state.articles.filter(a =>
        a.title.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
        a.content.toLowerCase().includes(state.searchQuery.toLowerCase())
      );

      document.getElementById('app').innerHTML = `
        <header class="bg-white border-b sticky top-0 z-10 shadow-sm">
          <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
                <span class="text-2xl">üìñ</span>
              </div>
              <h1 class="text-xl font-bold">Offline Reader</h1>
            </div>
            <div class="flex gap-2">
              <button onclick="state.showAddUrl = true; render();" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition font-medium">
                ‚ûï <span class="hidden sm:inline">Aggiungi</span>
              </button>
              <button onclick="state.showSettings = true; render();" class="p-2 hover:bg-slate-100 rounded-lg">
                ‚öôÔ∏è
              </button>
            </div>
          </div>
        </header>

        ${state.notification ? `
          <div class="fixed top-20 right-4 left-4 sm:left-auto sm:w-96 z-50 px-4 py-3 rounded-lg shadow-2xl animate-slide-in ${state.notification.type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white">
            ${state.notification.message}
          </div>
        ` : ''}

        ${state.showSettings ? `
          <div class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-md w-full p-6">
              <div class="flex justify-between mb-6">
                <h2 class="text-2xl font-bold">‚öôÔ∏è Impostazioni</h2>
                <button onclick="state.showSettings = false; render();" class="text-slate-400">‚úñÔ∏è</button>
              </div>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold mb-2">Provider AI</label>
                  <select onchange="state.provider = this.value;" class="w-full px-4 py-3 border-2 rounded-xl">
                    <option value="gemini" ${state.provider === 'gemini' ? 'selected' : ''}>‚ú® Gemini (GRATIS)</option>
                    <option value="openai" ${state.provider === 'openai' ? 'selected' : ''}>ü§ñ OpenAI</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-semibold mb-2">Chiave API</label>
                  <input 
                    type="password" 
                    value="${state.apiKey}" 
                    oninput="state.apiKey = this.value;"
                    placeholder="${state.provider === 'gemini' ? 'AIza...' : 'sk-...'}"
                    class="w-full px-4 py-3 border-2 rounded-xl"
                  />
                  <p class="text-xs text-slate-500 mt-2">
                    ${state.provider === 'gemini' ? 'üîë GRATIS su aistudio.google.com' : 'üîí Salvata nel browser'}
                  </p>
                </div>

                <div class="bg-slate-50 rounded-lg p-3">
                  <p class="text-sm"><strong>${state.articles.length}</strong> articoli salvati</p>
                </div>
              </div>
              
              <button onclick="saveSettings();" class="w-full mt-6 px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold">
                Salva
              </button>
            </div>
          </div>
        ` : ''}

        ${state.showAddUrl ? `
          <div class="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-md w-full p-6">
              <div class="flex justify-between mb-6">
                <h2 class="text-2xl font-bold">üì• Aggiungi</h2>
                <button onclick="state.showAddUrl = false; state.urlInput = ''; render();" class="text-slate-400">‚úñÔ∏è</button>
              </div>
              
              <input 
                type="url" 
                value="${state.urlInput}" 
                oninput="state.urlInput = this.value;"
                onkeypress="if(event.key === 'Enter') addArticle();"
                placeholder="https://example.com/articolo"
                class="w-full px-4 py-3 border-2 rounded-xl mb-4"
              />
              
              <button 
                onclick="addArticle();" 
                ${state.loading ? 'disabled' : ''}
                class="w-full px-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold disabled:opacity-50"
              >
                ${state.loading ? '‚è≥ Download...' : 'üíæ Scarica'}
              </button>
            </div>
          </div>
        ` : ''}

        <main class="max-w-6xl mx-auto px-4 py-6">
          ${state.view === 'list' ? `
            ${state.articles.length > 0 ? `
              <div class="mb-6">
                <input 
                  type="text" 
                  value="${state.searchQuery}"
                  oninput="state.searchQuery = this.value; render();"
                  placeholder="üîç Cerca..."
                  class="w-full px-4 py-3 border-2 rounded-xl"
                />
              </div>
            ` : ''}

            ${filteredArticles.length === 0 && state.articles.length === 0 ? `
              <div class="text-center py-20">
                <div class="text-6xl mb-6">üìñ</div>
                <h3 class="text-xl font-bold mb-2">Nessun articolo</h3>
                <p class="text-slate-500 mb-6">Inizia salvando un articolo</p>
                <button onclick="state.showAddUrl = true; render();" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-semibold">
                  ‚ûï Aggiungi Primo Articolo
                </button>
              </div>
            ` : `
              <div class="grid gap-4">
                ${filteredArticles.map(a => `
                  <div class="bg-white rounded-xl p-5 shadow-sm hover:shadow-xl transition border">
                    <h3 class="font-bold text-lg mb-2">${a.title}</h3>
                    <p class="text-sm text-slate-500 mb-3">
                      ${new URL(a.url).hostname} ‚Ä¢ ${new Date(a.savedAt).toLocaleDateString('it-IT')}
                    </p>
                    <p class="text-sm text-slate-600 mb-4 line-clamp-2">${a.content.substring(0, 150)}...</p>
                    <div class="flex flex-wrap gap-2">
                      <button onclick="selectArticle(${a.id})" class="px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg text-sm font-medium">
                        üìñ Leggi
                      </button>
                      <button onclick="summarizeArticle(${a.id})" ${state.loading ? 'disabled' : ''} class="px-3 py-1.5 bg-purple-50 text-purple-700 rounded-lg text-sm font-medium disabled:opacity-50">
                        ‚ú® Riassumi
                      </button>
                      <button onclick="translateArticle(${a.id})" ${state.loading ? 'disabled' : ''} class="px-3 py-1.5 bg-green-50 text-green-700 rounded-lg text-sm font-medium disabled:opacity-50">
                        üåç Traduci
                      </button>
                      <button onclick="exportArticle(${a.id})" class="px-3 py-1.5 bg-orange-50 text-orange-700 rounded-lg text-sm font-medium">
                        üìÑ Esporta
                      </button>
                      <button onclick="deleteArticle(${a.id})" class="px-3 py-1.5 bg-red-50 text-red-700 rounded-lg text-sm font-medium">
                        üóëÔ∏è
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          ` : `
            <div class="bg-white rounded-xl shadow-lg">
              <div class="p-6 border-b">
                <button onclick="backToList()" class="text-blue-600 mb-4 font-medium">‚Üê Torna</button>
                <h2 class="text-2xl font-bold mb-3">${state.selectedArticle?.title}</h2>
                <a href="${state.selectedArticle?.url}" target="_blank" class="text-sm text-blue-600 hover:underline">
                  ${state.selectedArticle?.url}
                </a>
              </div>

              <div class="p-6 border-b flex flex-wrap gap-3">
                <button onclick="summarizeArticle(${state.selectedArticle?.id})" ${state.loading ? 'disabled' : ''} class="px-5 py-2.5 bg-purple-600 text-white rounded-lg font-semibold disabled:opacity-50">
                  ‚ú® Riassumi
                </button>
                <button onclick="translateArticle(${state.selectedArticle?.id})" ${state.loading ? 'disabled' : ''} class="px-5 py-2.5 bg-green-600 text-white rounded-lg font-semibold disabled:opacity-50">
                  üåç Traduci
                </button>
                <button onclick="exportArticle(${state.selectedArticle?.id})" class="px-5 py-2.5 bg-orange-600 text-white rounded-lg font-semibold">
                  üìÑ Esporta
                </button>
              </div>

              <div class="p-6 max-w-3xl mx-auto">
                ${state.selectedArticle?.summary ? `
                  <div class="mb-8 p-6 bg-purple-50 rounded-xl border-2 border-purple-200">
                    <h3 class="text-xl font-bold text-purple-900 mb-4">‚ú® Riassunto</h3>
                    <p class="whitespace-pre-wrap">${state.selectedArticle.summary}</p>
                  </div>
                ` : ''}

                ${state.selectedArticle?.translation ? `
                  <div class="mb-8 p-6 bg-green-50 rounded-xl border-2 border-green-200">
                    <h3 class="text-xl font-bold text-green-900 mb-4">üåç Traduzione</h3>
                    <p class="whitespace-pre-wrap">${state.selectedArticle.translation}</p>
                  </div>
                ` : ''}

                <div>
                  <h3 class="text-xl font-bold mb-4 pb-3 border-b-2">Contenuto</h3>
                  <p class="whitespace-pre-wrap leading-relaxed">${state.selectedArticle?.content}</p>
                </div>
              </div>
            </div>
          `}
        </main>

        <footer class="text-center py-6 text-sm text-slate-500">
          <p>üí° Installa su iPhone: Safari ‚Üí Condividi ‚Üí Aggiungi a Home</p>
        </footer>
      `;
    };

    // Init
    (async () => {
      state.articles = await getAllArticles();
      state.articles.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
      
      const params = new URLSearchParams(window.location.search);
      const sharedUrl = params.get('add');
      if (sharedUrl) {
        state.urlInput = decodeURIComponent(sharedUrl);
        state.showAddUrl = true;
      }
      
      render();
    })();
  </script>
</body>
</html>
